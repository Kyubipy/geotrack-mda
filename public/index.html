<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="theme-color" content="#080c15">
<title>GeoTrack ¬∑ Dashboard</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<style>
  *{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
  body{font-family:system-ui,-apple-system,sans-serif;background:#080c15;color:#f1f5f9;overflow:hidden;height:100vh;height:100dvh}
  #map{position:absolute;inset:0;z-index:1}
  .leaflet-control-zoom,.leaflet-control-attribution{display:none!important}

  .top{position:fixed;top:0;left:0;right:0;z-index:900;padding:max(env(safe-area-inset-top),8px) 14px 10px;background:linear-gradient(180deg,rgba(8,12,21,0.95) 60%,transparent);display:flex;align-items:center;justify-content:space-between}
  .logo{display:flex;align-items:center;gap:10px}
  .logo-dot{width:9px;height:9px;background:#22d3ee;border-radius:50%;box-shadow:0 0 10px rgba(34,211,238,0.5);animation:blink 2s infinite}
  .logo h1{font-size:13px;font-weight:800;letter-spacing:2px;text-transform:uppercase;color:#22d3ee}
  .logo small{font-size:10px;color:#475569;display:block}
  .live{display:flex;align-items:center;gap:5px;font-size:10px;font-weight:700;color:#34d399;letter-spacing:1.5px}
  .live-dot{width:6px;height:6px;background:#34d399;border-radius:50%;animation:blink 1.5s infinite}
  .clock{font-family:monospace;font-size:13px;color:#94a3b8;font-weight:700}

  .stats-bar{position:fixed;bottom:0;left:0;right:0;z-index:900;padding:8px 10px max(env(safe-area-inset-bottom),10px);background:linear-gradient(0deg,rgba(8,12,21,0.95) 60%,transparent);display:flex;gap:6px;justify-content:center;flex-wrap:wrap}
  .pill{display:flex;align-items:center;gap:6px;padding:7px 12px;border-radius:20px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.07)}
  .pill .v{font-family:monospace;font-size:15px;font-weight:700}
  .pill .l{font-size:9px;color:#94a3b8;text-transform:uppercase;letter-spacing:0.5px}

  .zoom-btns{position:fixed;bottom:72px;right:10px;z-index:901;display:flex;flex-direction:column;gap:4px}
  .zbtn{width:36px;height:36px;border-radius:8px;background:rgba(12,17,30,0.94);border:1px solid rgba(255,255,255,0.07);color:#f1f5f9;font-size:18px;cursor:pointer;display:flex;align-items:center;justify-content:center}
  .zbtn:active{background:rgba(255,255,255,0.1)}

  .wait{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:900;text-align:center;color:#64748b;font-size:13px;padding:20px;background:rgba(8,12,21,0.9);border-radius:12px;border:1px solid rgba(255,255,255,0.07)}
  .wait.hidden{display:none}

  .mk{width:16px;height:16px;border-radius:50%;border:2px solid rgba(255,255,255,0.9)}
  .mk-ring{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:28px;height:28px;border-radius:50%;border:1.5px solid;opacity:0;animation:ping 2.5s ease-out infinite}

  .leaflet-popup-content-wrapper{background:rgba(12,17,30,0.94)!important;border:1px solid rgba(255,255,255,0.07)!important;border-radius:12px!important;color:#f1f5f9!important;box-shadow:0 8px 30px rgba(0,0,0,0.5)!important}
  .leaflet-popup-tip{background:rgba(12,17,30,0.94)!important}
  .leaflet-popup-close-button{color:#475569!important}

  @keyframes blink{0%,100%{opacity:1}50%{opacity:0.3}}
  @keyframes ping{0%{width:16px;height:16px;opacity:0.7}100%{width:44px;height:44px;opacity:0}}
</style>
</head>
<body>

<div class="top">
  <div class="logo">
    <div class="logo-dot"></div>
    <div>
      <h1>GeoTrack</h1>
      <small>Fiscalizaci√≥n ¬∑ MDA</small>
    </div>
  </div>
  <div style="text-align:right">
    <div class="live"><div class="live-dot"></div>EN VIVO</div>
    <div class="clock" id="clk">--:--</div>
  </div>
</div>

<div class="zoom-btns">
  <button class="zbtn" onclick="map.zoomIn()">+</button>
  <button class="zbtn" onclick="map.zoomOut()">‚àí</button>
</div>

<div class="stats-bar">
  <div class="pill"><span class="v" style="color:#22d3ee" id="sT">0</span><span class="l">Fiscalizadores</span></div>
  <div class="pill"><span class="v" style="color:#34d399" id="sU">0</span><span class="l">Se√±ales</span></div>
</div>

<div class="wait" id="waitMsg">‚è≥ Esperando se√±ales...<br><small>Abr√≠ tracker.html en un celular</small></div>

<div id="map"></div>

<script>
// ============================================
// CREDENCIALES
// ============================================
var SUPA_URL = 'https://wyxrtqudbjbwwlmqlrbc.supabase.co';
var SUPA_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Ind5eHJ0cXVkYmpid3dsbXFscmJjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgyOTc2ODcsImV4cCI6MjA3Mzg3MzY4N30.vV0m-2D9Hod6t3CwW9ggFlgmMewlF0SaeuC2horX8fs';

// ============================================
// MAP
// ============================================
var map = L.map('map', {center:[-25.2867,-57.6470], zoom:14, zoomControl:false, attributionControl:false});
L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png',{subdomains:'abcd',maxZoom:19}).addTo(map);

// ============================================
// STATE
// ============================================
var fiscs = {};    // { id: { nombre, color, zona } }
var markers = {};  // { id: L.marker }
var trails = {};   // { id: [[lat,lng], ...] }
var trailLines = {};
var totalSignals = 0;

// ============================================
// SUPABASE FETCH HELPER
// ============================================
function supaGet(path) {
  return fetch(SUPA_URL + '/rest/v1/' + path, {
    headers: {
      'apikey': SUPA_KEY,
      'Authorization': 'Bearer ' + SUPA_KEY
    }
  }).then(function(r) { return r.json(); });
}

// ============================================
// LOAD DATA
// ============================================
function loadAll() {
  // Get fiscalizadores
  supaGet('fiscalizadores?activo=eq.true&select=*').then(function(data) {
    if (!data || !data.length) return;
    data.forEach(function(f) {
      fiscs[f.id] = { nombre: f.nombre, color: f.color || '#22d3ee', zona: f.zona || '' };
      trails[f.id] = [];
      trailLines[f.id] = L.polyline([], {color: f.color || '#22d3ee', weight:2, opacity:0.3, dashArray:'4 6'}).addTo(map);
    });

    // Get last 50 ubicaciones per fiscalizador
    Object.keys(fiscs).forEach(function(fid) {
      supaGet('ubicaciones?fiscalizador_id=eq.' + fid + '&order=timestamp.desc&limit=50').then(function(locs) {
        if (!locs || !locs.length) return;

        // Hide waiting message
        document.getElementById('waitMsg').classList.add('hidden');

        var latest = locs[0];
        totalSignals += locs.length;

        // Create/update marker
        updateMarker(fid, latest.lat, latest.lng, latest.speed || 0, new Date(latest.timestamp));

        // Trail
        var pts = locs.reverse().map(function(l) { return [l.lat, l.lng]; });
        trails[fid] = pts;
        trailLines[fid].setLatLngs(pts);

        // Fit map
        fitAll();
        updateStats();
      });
    });
  });
}

function updateMarker(fid, lat, lng, speed, time) {
  var f = fiscs[fid];
  if (!f) return;

  var icon = L.divIcon({
    className:'',
    html:'<div style="position:relative;width:32px;height:32px;display:flex;align-items:center;justify-content:center"><div class="mk-ring" style="border-color:'+f.color+'"></div><div class="mk" style="background:'+f.color+'"></div></div>',
    iconSize:[32,32], iconAnchor:[16,16]
  });

  var ago = timeAgo(time);
  var popup = '<div style="font-family:system-ui;padding:4px;min-width:160px">' +
    '<div style="font-size:14px;font-weight:700;color:'+f.color+'">' + f.nombre + '</div>' +
    '<div style="font-size:11px;color:#94a3b8;margin-bottom:8px">üìç ' + (f.zona || 'En campo') + '</div>' +
    '<div style="font-size:12px;display:flex;justify-content:space-between;margin-bottom:3px"><span>Velocidad</span><span style="font-weight:600">' + speed.toFixed(1) + ' km/h</span></div>' +
    '<div style="font-size:10px;color:#475569;margin-top:6px;border-top:1px solid rgba(255,255,255,0.07);padding-top:6px">√öltima se√±al: ' + ago + '</div>' +
    '</div>';

  if (markers[fid]) {
    markers[fid].setLatLng([lat, lng]);
    markers[fid].setPopupContent(popup);
  } else {
    markers[fid] = L.marker([lat, lng], {icon: icon}).addTo(map);
    markers[fid].bindPopup(popup, {closeButton:true, maxWidth:220});
  }
}

// ============================================
// POLLING (cada 10s, simple y confiable)
// ============================================
function pollUpdates() {
  Object.keys(fiscs).forEach(function(fid) {
    supaGet('ubicaciones?fiscalizador_id=eq.' + fid + '&order=timestamp.desc&limit=1').then(function(locs) {
      if (!locs || !locs.length) return;
      var l = locs[0];

      document.getElementById('waitMsg').classList.add('hidden');

      updateMarker(fid, l.lat, l.lng, l.speed || 0, new Date(l.timestamp));

      // Add to trail
      var last = trails[fid];
      var newPt = [l.lat, l.lng];
      if (!last.length || last[last.length-1][0] !== newPt[0] || last[last.length-1][1] !== newPt[1]) {
        trails[fid].push(newPt);
        if (trails[fid].length > 60) trails[fid].shift();
        trailLines[fid].setLatLngs(trails[fid]);
        totalSignals++;
      }

      updateStats();
    });
  });
}

// ============================================
// HELPERS
// ============================================
function fitAll() {
  var pts = [];
  Object.keys(markers).forEach(function(id) {
    var ll = markers[id].getLatLng();
    pts.push([ll.lat, ll.lng]);
  });
  if (pts.length > 0) map.fitBounds(pts, {padding:[80,40], maxZoom:16});
}

function updateStats() {
  document.getElementById('sT').textContent = Object.keys(markers).length;
  document.getElementById('sU').textContent = totalSignals;
}

function timeAgo(date) {
  var s = Math.floor((Date.now() - date.getTime()) / 1000);
  if (s < 10) return 'ahora';
  if (s < 60) return s + 's';
  if (s < 3600) return Math.floor(s/60) + ' min';
  return Math.floor(s/3600) + 'h';
}

function updateClock() {
  var now = new Date();
  var h = String(now.getHours()).padStart(2,'0');
  var m = String(now.getMinutes()).padStart(2,'0');
  var s = String(now.getSeconds()).padStart(2,'0');
  document.getElementById('clk').textContent = h + ':' + m + ':' + s;
}

// ============================================
// INIT
// ============================================
updateClock();
setInterval(updateClock, 1000);
loadAll();
setInterval(pollUpdates, 10000);
</script>
</body>
</html>
