<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="theme-color" content="#080c15">
<title>GeoTrack ¬∑ Tracker</title>
<style>
  *{margin:0;padding:0;box-sizing:border-box}
  body{font-family:system-ui,-apple-system,sans-serif;background:#080c15;color:#f1f5f9;min-height:100vh;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:20px}
  .card{background:rgba(15,20,35,0.95);border:1px solid rgba(255,255,255,0.07);border-radius:20px;padding:30px;width:100%;max-width:380px;text-align:center}
  h1{font-size:15px;font-weight:800;letter-spacing:2px;text-transform:uppercase;color:#22d3ee;margin-bottom:4px}
  .sub{font-size:11px;color:#475569;margin-bottom:24px}
  .ring{width:120px;height:120px;border-radius:50%;margin:0 auto 20px;display:flex;align-items:center;justify-content:center;transition:all 0.5s}
  .ring.off{border:3px solid #334155;background:rgba(51,65,85,0.1)}
  .ring.on{border:3px solid #22d3ee;background:rgba(34,211,238,0.05);box-shadow:0 0 40px rgba(34,211,238,0.15)}
  .ring.err{border:3px solid #f87171;background:rgba(248,113,113,0.05)}
  .icon{font-size:40px}
  .stxt{font-size:15px;font-weight:700;margin-bottom:6px}
  .ssub{font-size:12px;color:#94a3b8;margin-bottom:24px}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin:20px 0}
  .gi{background:rgba(255,255,255,0.03);border-radius:10px;padding:12px 8px}
  .gv{font-family:monospace;font-size:16px;font-weight:700;color:#22d3ee}
  .gl{font-size:9px;color:#64748b;text-transform:uppercase;letter-spacing:0.5px;margin-top:2px}
  .btn{width:100%;padding:14px;border-radius:12px;border:none;font-size:14px;font-weight:700;cursor:pointer;letter-spacing:1px;text-transform:uppercase;transition:all 0.3s}
  .btn-go{background:linear-gradient(135deg,#22d3ee,#0891b2);color:#080c15}
  .btn-go:active{transform:scale(0.97)}
  .btn-no{background:rgba(248,113,113,0.15);color:#f87171;border:1px solid rgba(248,113,113,0.3);display:none}
  .btn-no:active{transform:scale(0.97)}
  .warn{font-size:10px;color:#fbbf24;margin-top:12px;padding:8px;background:rgba(251,191,36,0.05);border:1px solid rgba(251,191,36,0.15);border-radius:8px}
  .log{margin-top:16px;max-height:150px;overflow-y:auto;text-align:left;padding:10px;background:rgba(0,0,0,0.3);border-radius:10px}
  .ll{font-family:monospace;font-size:10px;color:#475569;margin-bottom:3px}
  .ll.ok{color:#34d399}
  .ll.er{color:#f87171}
</style>
</head>
<body>

<div class="card">
  <h1>üìç GeoTrack</h1>
  <div class="sub">Tracker ¬∑ Municipalidad de Asunci√≥n</div>

  <div class="ring off" id="ring">
    <span class="icon" id="icon">üìç</span>
  </div>
  <div class="stxt" id="stxt">Listo para rastrear</div>
  <div class="ssub" id="ssub">Presion√° Iniciar para comenzar</div>

  <div class="grid">
    <div class="gi">
      <div class="gv" id="dLat">--</div>
      <div class="gl">Latitud</div>
    </div>
    <div class="gi">
      <div class="gv" id="dLng">--</div>
      <div class="gl">Longitud</div>
    </div>
    <div class="gi">
      <div class="gv" id="dSpd">--</div>
      <div class="gl">Km/h</div>
    </div>
    <div class="gi">
      <div class="gv" id="dSent">0</div>
      <div class="gl">Enviados</div>
    </div>
  </div>

  <button class="btn btn-go" id="btnGo" onclick="startTracking()">Iniciar Rastreo</button>
  <button class="btn btn-no" id="btnNo" onclick="stopTracking()">Detener</button>

  <div class="warn">‚ö†Ô∏è Manten√© la pantalla encendida y no minimices el navegador.</div>

  <div class="log" id="log"></div>
</div>

<script>
// ============================================
// CREDENCIALES - YA CONFIGURADAS
// ============================================
var SUPA_URL = 'https://wyxrtqudbjbwwlmqlrbc.supabase.co';
var SUPA_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Ind5eHJ0cXVkYmpid3dsbXFscmJjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgyOTc2ODcsImV4cCI6MjA3Mzg3MzY4N30.vV0m-2D9Hod6t3CwW9ggFlgmMewlF0SaeuC2horX8fs';
var FISC_ID = '6f738c3d-4a4f-4568-9f92-29f9012c6d6a';

// ============================================
// VARIABLES
// ============================================
var watchId = null;
var sendTimer = null;
var lastPos = null;
var sentCount = 0;
var wakeLock = null;

// ============================================
// ENVIAR A SUPABASE (fetch puro, sin SDK)
// ============================================
function enviar(lat, lng, speed, accuracy) {
  return fetch(SUPA_URL + '/rest/v1/ubicaciones', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'apikey': SUPA_KEY,
      'Authorization': 'Bearer ' + SUPA_KEY,
      'Prefer': 'return=minimal'
    },
    body: JSON.stringify({
      fiscalizador_id: FISC_ID,
      lat: lat,
      lng: lng,
      speed: speed,
      accuracy: accuracy
    })
  });
}

// ============================================
// INICIAR RASTREO
// ============================================
function startTracking() {
  if (!navigator.geolocation) {
    setStatus('err', '‚ùå', 'Sin GPS', 'Tu navegador no soporta geolocalizaci√≥n');
    return;
  }

  // Wake lock para que no se apague la pantalla
  if ('wakeLock' in navigator) {
    navigator.wakeLock.request('screen').then(function(wl) {
      wakeLock = wl;
      addLog('Pantalla no se apagar√° ‚úì', 'ok');
    }).catch(function() {
      addLog('Wake Lock no disponible', 'er');
    });
  }

  // Escuchar GPS
  watchId = navigator.geolocation.watchPosition(
    function(pos) {
      lastPos = {
        lat: pos.coords.latitude,
        lng: pos.coords.longitude,
        speed: pos.coords.speed ? (pos.coords.speed * 3.6) : 0,
        accuracy: pos.coords.accuracy || 0
      };
      document.getElementById('dLat').textContent = lastPos.lat.toFixed(5);
      document.getElementById('dLng').textContent = lastPos.lng.toFixed(5);
      document.getElementById('dSpd').textContent = lastPos.speed.toFixed(1);
    },
    function(err) {
      addLog('Error GPS: ' + err.message, 'er');
      setStatus('err', '‚ùå', 'Error GPS', err.message);
    },
    { enableHighAccuracy: true, maximumAge: 5000, timeout: 15000 }
  );

  // Enviar cada 15 segundos
  sendTimer = setInterval(sendPosition, 15000);
  // Primer env√≠o en 2 segundos
  setTimeout(sendPosition, 2000);

  setStatus('on', 'üì°', 'Rastreando...', 'Enviando cada 15 segundos');
  document.getElementById('btnGo').style.display = 'none';
  document.getElementById('btnNo').style.display = 'block';
  addLog('Rastreo iniciado ‚úì', 'ok');
}

// ============================================
// DETENER
// ============================================
function stopTracking() {
  if (watchId !== null) { navigator.geolocation.clearWatch(watchId); watchId = null; }
  if (sendTimer) { clearInterval(sendTimer); sendTimer = null; }
  if (wakeLock) { wakeLock.release(); wakeLock = null; }
  lastPos = null;
  setStatus('off', 'üìç', 'Detenido', 'Rastreo pausado');
  document.getElementById('btnGo').style.display = 'block';
  document.getElementById('btnNo').style.display = 'none';
  addLog('Rastreo detenido', 'er');
}

// ============================================
// ENVIAR POSICI√ìN
// ============================================
function sendPosition() {
  if (!lastPos) { addLog('Esperando se√±al GPS...', 'er'); return; }
  enviar(lastPos.lat, lastPos.lng, lastPos.speed, lastPos.accuracy)
    .then(function(res) {
      if (!res.ok) throw new Error('HTTP ' + res.status);
      sentCount++;
      document.getElementById('dSent').textContent = sentCount;
      addLog('Enviado #' + sentCount + ': ' + lastPos.lat.toFixed(4) + ', ' + lastPos.lng.toFixed(4), 'ok');
    })
    .catch(function(e) {
      addLog('Error: ' + e.message, 'er');
    });
}

// ============================================
// HELPERS UI
// ============================================
function setStatus(type, icon, text, sub) {
  document.getElementById('ring').className = 'ring ' + type;
  document.getElementById('icon').textContent = icon;
  document.getElementById('stxt').textContent = text;
  document.getElementById('ssub').textContent = sub;
}

function addLog(msg, type) {
  var log = document.getElementById('log');
  var now = new Date();
  var h = String(now.getHours()).padStart(2,'0');
  var m = String(now.getMinutes()).padStart(2,'0');
  var s = String(now.getSeconds()).padStart(2,'0');
  var time = h + ':' + m + ':' + s;
  var div = document.createElement('div');
  div.className = 'll ' + (type || '');
  div.textContent = time + ' ¬∑ ' + msg;
  if (log.firstChild) {
    log.insertBefore(div, log.firstChild);
  } else {
    log.appendChild(div);
  }
  while (log.children.length > 30) log.removeChild(log.lastChild);
}

// Re-activar wake lock al volver a la app
document.addEventListener('visibilitychange', function() {
  if (document.visibilityState === 'visible' && watchId !== null && !wakeLock) {
    if ('wakeLock' in navigator) {
      navigator.wakeLock.request('screen').then(function(wl) {
        wakeLock = wl;
        addLog('Wake Lock re-activado ‚úì', 'ok');
      }).catch(function() {});
    }
  }
});

// Mensaje inicial
addLog('Conectado a Supabase ‚úì', 'ok');
addLog('Fiscalizador: Robert', 'ok');
addLog('Presion√° INICIAR RASTREO', 'ok');
</script>
</body>
</html>
